{% extends 'core/base.html' %}
{% load static %}

{% load get_custom %}
{% load static_image %}

{% load thumbnail %}

{% block title %}Account{% endblock %}

{% block body %}
<div class="bg-base-200">
  <section class="relative block h-[400px]">
    <div class="absolute top-0 w-full h-full bg-center bg-cover" style="
          background-image: url('https://images.unsplash.com/photo-1499336315816-097655dcfbda?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=2710&amp;q=80');
        ">
      <span id="blackOverlay" class="w-full h-full absolute dark:opacity-50 opacity-0 bg-black"></span>
    </div>
    <div class="top-auto bottom-0 left-0 right-0 w-full absolute pointer-events-none overflow-hidden h-[70px]" style="transform: translateZ(0px)">
      <svg class="absolute bottom-0 overflow-hidden" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" version="1.1" viewBox="0 0 2560 100" x="0" y="0">
        <polygon class="text-base-200 fill-current" points="2560 0 2560 100 0 100"></polygon>
      </svg>
    </div>
  </section>
  <section class="relative py-16 bg-base-200">
    <div class="container mx-auto px-4">
      <div class="relative flex flex-col min-w-0 break-words bg-base-100 w-full mb-6 shadow-xl rounded-lg -mt-64">
        <div class="px-6">

          <!-- Top banner -->
          <div class="flex flex-wrap justify-center">
            <!-- profile pic-->
            <div class="w-full lg:w-3/12 px-4 lg:order-2 flex justify-center">
              <div class="relative">
                {% firstof "/media/profile_pictures/default.jpg" as default_pic %}
                {% if account.profile_picture.url != default_pic %}
                  {% thumbnail account.profile_picture "150x150" crop="center" as im %}
                    <img alt="..." src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}"
                    class="shadow-xl rounded-full h-auto align-middle border-none absolute -m-16 -ml-20 lg:-ml-16 max-w-fit"
                    >
                  {% endthumbnail %}
                {% else %}
                  {% thumbnail "default_avatar.jpg"|static_image "150x150" crop="center" as im %}
                    <img alt="..." src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}"
                    class="shadow-xl rounded-full h-auto align-middle border-none absolute -m-16 -ml-20 lg:-ml-16 max-w-fit"
                    >
                  {% endthumbnail %}
                {% endif %}
              </div>
            </div>
            <!-- CASE 1 : VISITING OTHER USER'S PROFILE PAGE-->
            {% if user != account %}
            <div class="w-full lg:w-4/12 px-4 lg:order-3 lg:text-right lg:self-center">
              <!-- CONNECTION BUTTONS -->
              {% include 'partials/account_connection_buttons.html' %}
            </div>
            <!-- dashboard -->
            {% include 'partials/account_dashboard.html' %}
          </div> <!-- END CASE 1 -->
          <!-- CASE 2 : USER'S OWN PROFILE PAGE-->
          {% else %}
          <div class="w-full lg:w-4/12 px-4 lg:order-3 lg:text-right lg:self-center">
            <!-- SETTINGS -->
            <div class="max-sm:text-center py-6 px-3 mt-32 sm:mt-0">
              <a href="{% url 'accounts:edit_account' user.pk %}" class="btn btn-outline" type="button">
                <svg class="w-5 h-5 stroke-current"  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                settings
              </a>
            </div>
          </div>
          <!-- dashboard -->
            {% include 'partials/account_dashboard.html' %}
        </div>
        {% endif %} <!-- END CASE 2 -->

          <!-- USER INFOS -->
          {% include 'partials/account_infos.html' %}

          <div class="mt-10 py-8 border-t border-gray-200 text-center">
            {% if user == account %}
              <!-- SHOW LIST OF RELATIONS -->
              <div class="my-10 p-4 bg-base-200 w-full max-w-4xl rounded-xl">
                <div class="py-2 flex gap-4 items-center">
                  <h1 class="text-2xl font-semibold">Connected accounts</h1>
                  <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" enable-background="new 0 0 52 52" xml:space="preserve" transform="rotate(-45)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M17.3,36.1l-1.1-1.4c0,0-0.7-1-0.9-1.6c-0.2-0.3-0.5-0.5-0.9-0.5h-0.6c-3.5,0-6.5-2.6-6.7-6 c-0.3-3.8,2.8-6.9,6.5-6.9h9.1c1.2,0,2.3,0.4,3.2,0.8c1.2,0.7,2.2,1.8,2.7,3.1c0.3,0.8,0.5,1.6,0.5,2.6c0,0.5-0.1,0.9-0.2,1.4 c-0.2,0.7,0.3,1.3,1,1.2l3.4,0c0.5,0,0.8-0.4,1-0.8c0.1-0.6,0.1-1.2,0.1-1.8c0-0.8-0.1-1.7-0.3-2.6c-0.3-1.4-0.9-2.7-1.7-3.9 c-1.5-2.2-3.8-4-6.4-4.7c-1-0.3-2.2-0.5-3.2-0.5H14c-6.3,0-11.7,4.9-11.9,11.2c-0.3,6.6,5,12.1,11.6,12.1h3 C17.4,37.7,17.8,36.7,17.3,36.1z M49.9,25.6c-0.2-6.3-5.6-11.3-11.9-11.2l-2.7-0.1c-0.8,0-1.3,1-0.8,1.6c0.8,0.9,1.4,1.9,2,3 c0.2,0.3,0.5,0.5,0.9,0.5H38c3.5,0,6.5,2.6,6.7,6c0.3,3.8-2.8,6.9-6.5,6.9l-9.1,0c-1.2,0-2.3-0.4-3.2-0.8c-1.2-0.7-2.2-1.8-2.7-3.1 c-0.3-0.8-0.5-1.6-0.5-2.6c0-0.5,0.1-0.9,0.2-1.4c0.2-0.7-0.3-1.3-1-1.2h-3.4c-0.5,0-0.8,0.4-1,0.8c-0.1,0.6-0.1,1.2-0.1,1.8 c0,0.8,0.1,1.8,0.3,2.6c0.3,1.4,0.9,2.7,1.7,3.8c1.5,2.2,3.8,4,6.4,4.7c1,0.3,2.2,0.5,3.2,0.5l9.1,0C44.8,37.7,50.1,32.2,49.9,25.6 z"></path> </g> </g></svg>
                </div>

                {% if relations %}
                <div class="overflow-x-auto">
                  <table class="table">
                    {% for relation_user, relation in users_relations_dict.items %}
                    <tbody>
                      <tr class="hover">
                        <th class="p-2">
                          <a href="{% url 'accounts:account_view' relation_user.id %}" class="cursor-pointer">
                            <div class="flex items-center space-x-3">
                              <div class="avatar">
                                <div class="mask mask-squircle w-10 h-10">
                                  {% if relation_user.profile_picture.url != default_pic %}
                                    {% thumbnail relation_user.profile_picture "50x50" crop="center" as im %}
                                      <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{% firstof relation_user.first_name relation_user.email %}'s profile pic" class="h-full w-full object-cover object-center group-hover:opacity-75">
                                    {% endthumbnail %}
                                  {% else %}
                                    {% thumbnail "default_avatar.jpg"|static_image "50x50" crop="center" as im %}
                                        <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{% firstof relation_user.first_name relation_user.email %}'s profile pic" class="h-full w-full object-cover object-center group-hover:opacity-75">
                                    {% endthumbnail %}
                                  {% endif %}
                                </div>
                              </div>
                              <div>
                                <div class="font-bold">
                                  {% firstof relation_user.first_name relation_user.last_name "-" %}
                                </div>
                                <div class="text-sm opacity-50">
                                  {{relation_user.email|truncatechars:12}}
                                </div>
                              </div>
                            </div>
                          </a>
                        </th>
                        <th><p class="badge badge-sm sm:badge-md ">{{relation.relation_type}}</p></th>
                      </tr>
                    </tbody>
                    {% endfor %}
                  </table>
                </div>
                {% endif %}
              </div>

              <!-- SEARCH BAR FOR OTHER USERS-->
              <div class="my-10">
                <h2 class="text-xl font-semibold">Look for family members or friends:</h2>
                <form method="GET" class="flex flex-wrap gap-2">
                  <input type="text" class="input input-bordered w-full" name="search-area" placeholder="Type to find users" value={{search_input}}>
                  <input type="submit" class="btn btn-default w-full" value="Search"></input>
                </form>
              </div>
              <!-- SEARCH RESULTS -->
              {% if search_input %}
              <div class="overflow-x-auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>User</th>
                    </tr>
                  </thead>
                  {% for searched_user in searched_users %}
                    {% if searched_user not in relations_users %}
                    <tbody>
                      <tr class="hover">
                        <th>
                          <a href="{% url 'accounts:account_view' searched_user.id %}" class="cursor-pointer">
                            <div class="flex items-center space-x-3">
                              <div class="avatar">
                                <div class="mask mask-squircle w-12 h-12">
                                  <img src="{% if searched_user.profile_picture %}{{searched_user.profile_picture.url}}{% else %} {% endif %}" alt="Avatar Tailwind CSS Component" />
                                </div>
                              </div>
                              <div>
                                <div class="font-bold">{% firstof searched_user.first_name searched_user.last_name "-" %}</div>
                                <div class="text-sm opacity-50">{{searched_user.email}}</div>
                              </div>
                            </div>
                          </a>
                        </th>
                      </tr>
                    </tbody>
                    {% endif %}
                  {% endfor %}
                </table>
              </div>
              {% endif %}

            {% endif %}
          </div>

          <!-- Relation between logged user and visisted account -->
          {% if user != account %}
            {% if relation_exists %}
            <div class="flex flex-col w-full my-8">
              <!-- Change relation type -->
              <form method="POST">
                {% csrf_token %}
                <details class="collapse collapse-arrow grid h-auto py-4 card bg-base-300 rounded-box place-items-center">

                  <summary class="collapse-title text-center">
                    {% if account.first_name %}{{account.first_name}}{% else %}{{account.email}}{% endif %} and you are connected as <span class="ml-1 badge">{{users_relations_dict|get_relation:account}}</span>
                  </summary>
                  <div class="collapse-content flex place-content-center gap-2">
                      <p>something wrong ? :</p>
                      <select name="change_relation" id="id_change_relation" class="select select-xs">
                        {% for option in relation_change_form.change_relation %}
                          {{option}}
                        {% endfor %}
                      </select>
                      <button class="btn btn-xs" type="submit" name="relation_change_form">save</button>
                  </div>
                </details>
              </form>

              <div class="divider"></div>
              <!-- DISCONNECT -->
              <div class="grid h-auto py-4 card bg-base-300 rounded-box place-items-center">
                <form method="POST">
                  {% csrf_token %}
                  <button type="submit" name="delete_form" class="btn btn-outline btn-error">
                    <span>
                      <svg class="w-5 h-5 stroke-current stroke-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"> <path id="Vector" d="M16 20V18M18 16H20M7.04996 11.293L5.63574 12.7072C4.07365 14.2693 4.07466 16.8016 5.63675 18.3637C7.19885 19.9258 9.7308 19.9262 11.2929 18.3641L12.7076 16.9497M6 8H4M8 4V6M11.293 7.05044L12.7072 5.63623C14.2693 4.07413 16.8016 4.07368 18.3637 5.63578C19.9258 7.19787 19.9254 9.7308 18.3633 11.2929L16.9492 12.7071" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </span>
                    disconnect
                  </button>
                </form>
              </div>
            </div>

            {% endif %}
          {% endif %}
        </div>
      </div>

      <p> {{friends_with_account}} </p>
    </div>


  </section>

</div>
{% endblock %}
