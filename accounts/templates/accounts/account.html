{% extends 'core/base.html' %}
{% load static %}

{% block title %}Account{% endblock %}

{% block body %}
<div class="bg-base-100">
  <div class="mx-auto max-w-2xl px-4 py-16 sm:px-6 sm:py-24 lg:max-w-7xl lg:px-8">
    <div class="prose">
      <h1 class="sr-only">Profile page</h1>
      <h1>
        {% if account == user %}Your profile
        {% else %} {% if account.first_name %}{{account.first_name|title}}{% else %}{{account.email}}{% endif %}'s profile
        {% endif %}
      </h1>
    </div>

    <!-- Other users' profile : managing the Friendship requests -->
    <div class="mt-6">
      {% if user != account %}
        {% if friendship_exists %}
          <div class="form-control w-full max-w-xs grid grid-cols-1 space-y-2">
            <p>you are friends with {% if account.first_name %}{{account.first_name}}{% else %}{{account.email}}{% endif %}</p>
            <form method="POST"> <!-- REQUEST FRIENDSHIP -->
              {% csrf_token %}
              <input type="submit" name="delete_form" class="btn btn-outline btn-error" value="Unfriend">
            </form>
          </div>
          {% else %}
          {% if request_to_exists %}
            <form method="POST"> <!-- REQUEST SENT -->
              {% csrf_token %}
              <a class="btn btn-success opacity-50 border border-2 border-emerald-700">Friendship Request Sent</a>
              <input type="submit" name="undo_request_form" class="btn btn-error btn-outline" value="Undo"></input>
            </form>
          {% elif request_from_exists %}
            <form method="POST"> <!-- ACCEPT FRIENSHIP REQUEST-->
              {% csrf_token %}
              <div class="form-control w-full max-w-xs grid grid-cols-1 space-y-2">
                <input type="submit" name="accept_form" class="btn btn-outline btn-info" value="Accept Friendship request">

                <label class="label">
                  <span class="label-text">Who is {% firstof account.first_name account.email %} to you ?</span>
                </label>
                <select class="select select-bordered" name="relation_type" id="id_relation_type">
                  {% for option in accept_form.relation_type %}
                  {{option}}
                  {% endfor %}
                </select>
              </div>
            </form>
          {% else %}
            <form method="POST"> <!-- REQUEST FRIENDSHIP -->
              {% csrf_token %}
              <input type="submit" name="request_form" class="btn btn-outline" value="Request Friendship">
            </form>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>

    <!-- USER PERSONAL INFO -->
    {% for name, value in account.get_fields %}
      {% if value %}
        <div class="prose prose-sm md:prose-base w-full max-w-4xl pt-10">
          <h3>{{ name|capfirst }}</h3>
          <h2>{{ value }}</h2>
        </div>
      {% endif %}
    {% endfor %}

  {% if user == account %}
  <!-- SHOW LIST OF RELATIONS -->
  <div class="my-10 p-4 bg-base-200 w-full max-w-4xl rounded-xl">
    <div class="py-2 flex gap-4 items-center">
      <h1 class="text-2xl font-semibold">Related accounts</h1>
      <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" enable-background="new 0 0 52 52" xml:space="preserve" transform="rotate(-45)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M17.3,36.1l-1.1-1.4c0,0-0.7-1-0.9-1.6c-0.2-0.3-0.5-0.5-0.9-0.5h-0.6c-3.5,0-6.5-2.6-6.7-6 c-0.3-3.8,2.8-6.9,6.5-6.9h9.1c1.2,0,2.3,0.4,3.2,0.8c1.2,0.7,2.2,1.8,2.7,3.1c0.3,0.8,0.5,1.6,0.5,2.6c0,0.5-0.1,0.9-0.2,1.4 c-0.2,0.7,0.3,1.3,1,1.2l3.4,0c0.5,0,0.8-0.4,1-0.8c0.1-0.6,0.1-1.2,0.1-1.8c0-0.8-0.1-1.7-0.3-2.6c-0.3-1.4-0.9-2.7-1.7-3.9 c-1.5-2.2-3.8-4-6.4-4.7c-1-0.3-2.2-0.5-3.2-0.5H14c-6.3,0-11.7,4.9-11.9,11.2c-0.3,6.6,5,12.1,11.6,12.1h3 C17.4,37.7,17.8,36.7,17.3,36.1z M49.9,25.6c-0.2-6.3-5.6-11.3-11.9-11.2l-2.7-0.1c-0.8,0-1.3,1-0.8,1.6c0.8,0.9,1.4,1.9,2,3 c0.2,0.3,0.5,0.5,0.9,0.5H38c3.5,0,6.5,2.6,6.7,6c0.3,3.8-2.8,6.9-6.5,6.9l-9.1,0c-1.2,0-2.3-0.4-3.2-0.8c-1.2-0.7-2.2-1.8-2.7-3.1 c-0.3-0.8-0.5-1.6-0.5-2.6c0-0.5,0.1-0.9,0.2-1.4c0.2-0.7-0.3-1.3-1-1.2h-3.4c-0.5,0-0.8,0.4-1,0.8c-0.1,0.6-0.1,1.2-0.1,1.8 c0,0.8,0.1,1.8,0.3,2.6c0.3,1.4,0.9,2.7,1.7,3.8c1.5,2.2,3.8,4,6.4,4.7c1,0.3,2.2,0.5,3.2,0.5l9.1,0C44.8,37.7,50.1,32.2,49.9,25.6 z"></path> </g> </g></svg>
    </div>

    {% if relations %}
    <div class="overflow-x-auto">
      <table class="table">

        {% for relation in relations %}
          <tbody>
            <tr class="hover">
              <th class="p-2">
                <a href="{% if user != relation.user_sending %}{% url 'accounts:account_view' relation.user_sending.id %}{% elif user != relation.user_receiving %}{% url 'accounts:account_view' relation.user_receiving.id %}{% endif %}" class="cursor-pointer">
                  <div class="flex items-center space-x-3">
                    <div class="avatar">
                      <div class="mask mask-squircle w-10 h-10">
                        <img src="{% if user != relation.user_sending %}{{relation.user_sending.profile_picture.url}}{% elif user != relation.user_receiving %}{{relation.user_receiving.profile_picture.url}} {% endif %}" alt="Avatar Tailwind CSS Component" />
                      </div>
                    </div>
                    <div>
                      <div class="font-bold">
                        {% if user != relation.user_sending %}
                          {% firstof relation.user_sending.first_name relation.user_sending.last_name "-" %}
                        {% elif user != relation.user_receiving %}
                          {% firstof relation.user_receiving.first_name relation.user_receiving.last_name "-" %}
                        {% endif %}
                      </div>
                      <div class="text-sm opacity-50">{% if user != relation.user_sending %}{{relation.user_sending.email|truncatechars:12}}{% elif user != relation.user_receiving %}{{relation.user_receiving.email|truncatechars:12}}{% endif %}</div>
                    </div>
                  </div>
                </a>
              </th>
              <th class="p-2">{{relation.relation_type}}</th>
            </tr>
          </tbody>
        {% endfor %}
      {% endif %}
      </table>
    </div>
  </div>

<!-- SEARCH BAR FOR OTHER USERS-->
    <div class="my-10">
      <h2 class="text-xl font-semibold">Look for family members or friends:</h2>
      <form method="GET" class="flex flex-wrap gap-2">
        <input type="text" class="input input-bordered w-full max-w-xs" name="search-area" placeholder="Type to find users" value={{search_input}}>
        <input type="submit" class="btn btn-default w-full max-w-xs sm:w-fit" value="Search"></input>
      </form>
    </div>

    {% if search_input %}
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>User</th>
            </tr>
          </thead>
          {% for user in searched_users %}
          <tbody>
            <tr class="hover">
              <th>
                <a href="{% url 'accounts:account_view' user.id %}" class="cursor-pointer">
                  <div class="flex items-center space-x-3">
                    <div class="avatar">
                      <div class="mask mask-squircle w-12 h-12">
                        <img src="{% if user.profile_picture %}{{user.profile_picture.url}}{% else %} {% endif %}" alt="Avatar Tailwind CSS Component" />
                      </div>
                    </div>
                    <div>
                      <div class="font-bold">{% if user.first_name or user.last_name %}{{user.first_name}} {{user.last_name}}{% else %}-{% endif %}</div>
                      <div class="text-sm opacity-50">{{user.email}}</div>
                    </div>
                  </div>
                </a>
              </th>
            </tr>
          </tbody>
          {% endfor %}
        </table>
      </div>
    {% endif %}

  {% endif %}



  {% if user == account %}
    <a href="{% url 'accounts:edit_account' user.pk %}" class="mt-10 btn btn-primary">Edit profile</a>
  {% endif %}


</div>
{% endblock %}
